<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>Distribution of Rare Plants in Kentucky</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
    <link href='https://fonts.googleapis.com/css?family=Pompiere' rel='stylesheet' type='text/css'>
    
<style>

        body {
            padding: 0;
            margin: 0;
            bottom: 0;
            font-family: 'Pompiere', cursive;
            background: url(plant.png);  
        }
        h1, #county-plants {
            position: absolute;
            left: 50px;
            top: 10px;
            font-family: 'Pompiere', cursive;
            font-size: 3em;
            font-weight: 300;
            color: #DCAE1D;  
        }
        #county-plants {
            top: 150px;
            left: 80px;
            font-size: 1.5em;
            z-index: 3;
            color: #7A9D96;
        }
        #map {
            position: absolute;
            top: 140px;
            bottom: 0;
            width: 100%; 
        }
/*
        footer {
            position: absolute;
            width: 100%;
            height: 8%;
            bottom: 0;
            color: aqua;
            background: black;
        }
*/
        #info {
            position: absolute;
            font-size: 1em;
            max-width: 245px; 
            display: none;
            overflow-y: scroll;
            height: 100px;
            color: #7A9D96;
            z-index: 2;
            left: 100px;
            top: 210px; 
            background: rgba(25,25,25,0.2);
            border-radius: 5px;
            padding: 14px 3%;
        }
        #plants {
            position: absolute;
            background: rgba(25,25,25,0.2);
            border-radius: 5px;
            padding: 14px 3%;
            width: 138px;
            top: 44px;
            right: 40px;
            height: 359px;
            overflow-y: scroll;
            color: #CAE4DB;
            z-index: 1;
        }
        #plants li {
            font-size: .9em;
        }
        #plants li:hover {
            text-decoration: underline;
            cursor: pointer;
        }
        .county {
          stroke: #fff;
          fill:#005DAA;
        }
        .hover {
            fill: yellow;   
        }

    </style>
</head>
<body>
    <h1>Distribution of Rare Plants in Kentucky</h1>
    <ul id="county-plants"></ul>
    <ul id="plants"></ul>
    <div id="info"></div>
    <div id="map"></div>

<!--
    <footer>
        <p>Map authored by Maria Renee Horn</p>
    </footer>
-->

    <script>
        
        var options = {
            center: [38.2, -85.8],
            zoom: 7,
            minZoom: 7,
            maxZoom: 9,
            dragging: false,
            zoomControl: true
        }
        
        var map = L.map('map', options);
         
        var tiles =  L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png', {
	           attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
	           subdomains: 'abcd',
	           maxZoom: 19,
        });
        
        map.addLayer(tiles);
        
        queue()
            .defer(d3.csv, 'data_project.csv')
            .defer(d3.json, 'ky-counties.json')
            .await(ready);
    
        function ready(err, data, counties) {
//            console.log(data, counties);  add specific plants found within each county to each county's properites
            counties.features.forEach(function(county,i) {
//                console.log(county);
                county.properties.plants = {};
                    data.forEach(function(d,j){
                        if(county.properties["STATE_FIP"] + 
                            county.properties["COUNTY_FIP"] === d["FIPS_ID"]) {
                                county.properties.plants[j] = d;
                                }
                       
                        });
            });
         
            //build up an object of the different species of plants plant name is the key, counties found within in as the value, 
            //stored within an array
         var plantsData = {}
            data.forEach(function(d,k){
                if(plantsData[d.CNAME]) {
                    plantsData[d.CNAME].counties.push(d.FIPS_ID);
                } else {
                    plantsData[d.CNAME] = {counties: [d.FIPS_ID]};
                }  
            });
         
         // dynamically create a list of the available plants
         var plantsList = d3.select('#plants'),
             listItems = '';
            for(var plant in plantsData) {
                listItems += '<li>'+plant+'</li>';
            }   // add this list to the DOM
                    plantsList.html(listItems);
         
                        makeMap(counties, plantsData);
        
        } // end ready
        
        function makeMap(counties, plantsData) {
         // you have access to counties and plantsData here
            countyPlants = L.geoJson(counties, {
                style: function(feature) {
                    return {
                        color: '#505160',
                        weight: 1,
                        fillOpacity: 1,
                        fillColor: '#080706'
                        }
                },
               
//                onEachFeature: function(feature, layer) {
//                    layer.on('click', function(e) {
//                        $("#county-plants").show().slideUp("slow");
//                            var name = layer.feature.properties.NAME;
//                        $("#county-plants").text(name + ' County:');
//                        
//                    layer.on('mouseout', function(){
//                        $("#county-plants").hide();
//                    });
//                })
//            }

                 onEachFeature: function(feature, layer) {
                            var props = layer.feature.properties;
                      layer.on('click', function(e) {
                                $("#county-plants").show().slideUp("slow");
                                      $('#info').show();
                      $("#county-plants").text(props.NAME + ' County:');
                     $('#info').html(getPlants(props.plants));
                           layer.setStyle({ fillColor: '#68829E', fillOpacity: 1 });
     })
                        layer.on('mouseout', function(){
              $("#county-plants").hide();
                   $('#info').hide();
                   layer.setStyle({ fillColor: '#080706', fillOpacity: 1 });
                });
        }
        }).addTo(map);
            
//                    retrieveInfo();
                    highlightCounties();  
            
            
        }
        
         function zoomToFeature(e) {
             map.fitBounds(e.target.getBounds());
         }  
        
        function retrieveInfo() {
            var info = $('#info');
                countyPlants.on('click', function(e) {
                    info.show();
                    
                      
            var props = e.layer.feature.properties.plants;
                if ($('#info').html(getPlants(props))) {
                    
                    e.layer.setStyle({ fillColor: '#505160', fillOpacity: 1 });
                    
                } else ($('#info').html({fillColor: '#080706', fillOpacity: 1}));
            });
             
//                countyPlants.on('mouseout', function(e) {
//                    info.hide();
//                        e.layer.setStyle({ fillColor: '#080706', fillOpacity: 1});
//            
//            }); 
           
        }
                                  
         function getPlants(plants) {
           var outputText = '';
                for (var plant in plants) {
                        outputText += '<li>' + plants[plant].CNAME + '</li>'
                }
            
            return outputText;  
             
        }
        
        function highlightCounties() {
           var list = $('#plants');
                list.on('mouseover', function(e) {
                    var selectedPlant = $(e.target).html();
                    console.log(selectedPlant);
                        countyPlants.setStyle({ fillColor: '#080706', fillOpacity: 1 });
                            countyPlants.eachLayer (function(layer) {
                                var plants = layer.feature.properties.plants;
                                console.log(plants);
                                    for(var plant in plants) {
                                        if(selectedPlant === plants[plant].CNAME) {
                                            layer.setStyle({ fillColor: '#AEBD38', fillOpacity: 1 });
                                        }
                                    }           
                            });
                });
        }
        
        
</script>
</body>
</html>

